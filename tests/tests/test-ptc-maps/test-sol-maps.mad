-- ../mad test-sol-maps.mad
-- assume ../madx64 to be present...

local object                                                    in MAD
local tblcat                                                    in MAD.utility
local run_test in require("trackvsptc")

-- The setup for the tests ----------------------------------------------------o

local ref_cfg = object "ref" {
  -- How to run the tests
  dorun  = true, -- Default: true 
  dosave = false, -- Default: false
  doprnt = false, -- Default: false
  dodbg  = false, -- Default: false
  doplot = false, -- Default: false

  gen_utest = true , -- Default: false

  
  -- list of variables in the tests
  alist = {"model", "energy", "method", "nslice", "x0i"}, --attributes list
  tol = 1000,

  -- list of values that are used to run test but are not changed throughout
  order  = 4,        -- 2/4
  icase  = 56,       -- 56/6
  debug  = 0,        -- 0/6
  snm    = -1,
  seql   =  2,

  x0i    = 1..5,       -- 0, 4D, 5D, 5D strong, 6D (see get_mad_str)
}

TestSol = {}

function TestSol:setUp()
  -- Turn off all unnecessary components for unit testing
  ref_cfg.gen_utest = false
  ref_cfg.dodbg     = false
  ref_cfg.doprnt    = false
  ref_cfg.dosave    = false
  
  -- Turn on the components for unit testing
  ref_cfg.dorun     = true
  ref_cfg.do_utest  = true
  ref_cfg.doplot    = true
end

-- MADX PTC makes assumptions on whether you solenoid is thin or thick 
-- see https://github.com/MethodicalAcceleratorDesign/MAD-X/issues/1147
function TestSol:testSOL()
  local cfg = ref_cfg "sol" {
    elm =  "SOLENOID, at=${l}/2, l=${l}, ks=${ks}",
    
    model  = {1,2},
    method = 2..8..2,    
    nslice = 1..3,
    energy = {1, 6500},  -- {1, 450, 6500}

    tol = 50,

    alist = tblcat(ref_cfg.alist, {"l", "ks"}),
    l        = {0.5, 1, 1.5},
    ks       = -0.6..0.6..0.3,

    plot_info = {
      series = {
        "${ks} == -0.6",
        "${ks} == -0.3",
        "${ks} == 0",
        "${ks} == 0.3",
        "${ks} == 0.6",
      },
      legend = {
        y1 = "ks = -0.6",
        y2 = "ks = -0.3",
        y3 = "ks = 0",
        y4 = "ks = 0.3",
        y5 = "ks = 0.6",
      },
      title = "Solenoid NG vs PTC",
      filename = "solenoid-body.png",
    }
  }
  run_test(cfg)
end

function TestSol:testSOLf()
  local cfg = ref_cfg "solf" {
    elm =  "SOLENOID, at=0.75, l=1.5, ks=${ks}, fringe=${fringe}, knl=${knl}, bend_fringe=false,\z
            frngmax=${frngmax}",
    
    model  = {2},
    method = {2, 6},    
    nslice = 1..3,
    energy = {1},  -- {1, 450, 6500}

    tol = 1700,

    alist = tblcat(ref_cfg.alist, {"ks", "fringe", "knl", "frngmax"}),
    ks       = {-0.6, 0, 0.3},
    knl = {
      {0   , 0  , 0, 0 }, 
      {0.05, 0.5, 5, 50},
    },
    fringe   = {14, 0}, -- 14 - qsad, solen and mult_fringe
    frngmax = 2..5,  

    plot_info = {
      series = {
        "${ks} == -0.6",
        "${ks} == 0",
        "${ks} == 0.3",
      },
      legend = {
        y1 = "ks = -0.6",
        y3 = "ks = 0",
        y4 = "ks = 0.3",
      },
      title = "Solenoid NG vs PTC, including fringe",
      filename = "solenoid-fringe.png",
    }
  }
  run_test(cfg)
end

function TestSol:testSOLm()
  local cfg = ref_cfg "solm" {
    elm =  "SOLENOID, at=0.75, lrad=1.5, ksi=${ksi}, knl=${knl}, ksl=${ksl}, fringe=${fringe},\z
            frngmax=${frngmax}",
    
    model  = {1},
    method = {2, 6},    
    nslice = 1..3,
    energy = {1},  -- {1, 450, 6500}

    tol = 100,

    alist = tblcat(ref_cfg.alist, {"ksi", "fringe", "knl", "ksl", "frngmax"}),
    knl = {
      {0   , 0  , 0, 0 }, 
      {0.05, 0.5, 5, 50},
    },
    ksi   = {-0.2, 0, 0.25},
    ksl   = \s-> s.knl,
    fringe   = 0..14..14,
    frngmax = 2..5,

    plot_info = {
      series = {
        "${ksi} == -0.2",
        "${ksi} == 0",
        "${ksi} == 0.25",
      },
      legend = {
        y1 = "ksi = -0.2",
        y2 = "ksi = 0",
        y3 = "ksi = 0.25",
      },
      title = "Thin Solenoid NG vs PTC, including fringe",
      filename = "solenoid-multipoles.png",
    }
  }
  run_test(cfg)
end

if debug.getinfo(3) == nil then
  TestSol:testSOL()
  TestSol:testSOLf()
  TestSol:testSOLm()
end